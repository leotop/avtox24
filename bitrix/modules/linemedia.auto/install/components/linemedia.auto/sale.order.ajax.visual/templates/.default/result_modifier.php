<?php/* * Настройки в главном модуле. */ $wsgroup     = (int) COption::GetOptionInt('linemedia.auto', 'LM_AUTO_WHOLESALE_GROUP');$wsperson    = (int) COption::GetOptionInt('linemedia.auto', 'LM_AUTO_WHOLESALE_PERSON');$wspaysystem = (int) COption::GetOptionInt('linemedia.auto', 'LM_AUTO_WHOLESALE_PAYSYSTEM');$wsstatus    = (string) COption::GetOptionString('linemedia.auto', 'LM_AUTO_WHOLESALE_STATUS', 'N');if (!empty($arResult['BASKET_ITEMS']) && in_array($wsgroup, $USER->GetUserGroupArray())) {			// TODO: добавить сопутствующие битриксовые данные по зазказу: скидки, налоги доставку и т.д.	$arFields = array(		"LID" => SITE_ID,		"PERSON_TYPE_ID" => $wsperson,		"PAYED" => "N",		"CANCELED" => "N",		"STATUS_ID" => $wsstatus,		"PRICE" => $arResult['ORDER_PRICE'],		"CURRENCY" => CCurrency::GetBaseCurrency(),		"USER_ID" => intval($USER->GetID()),		"PAY_SYSTEM_ID" => $wspaysystem,		"PRICE_DELIVERY" => 0,		"DELIVERY_ID" => 0,		"DISCOUNT_VALUE" => 0,		"TAX_VALUE" => 0,		"USER_DESCRIPTION" => ""	);		$events = GetModuleEvents("linemedia.auto", "OnBeforeOrderAdd");	while ($arEvent = $events->Fetch()) {		ExecuteModuleEventEx($arEvent, array(&$arFields, $arParams['MANAGER_TEMPLATE']));	}		// Создание заказа.	$ORDER_ID = CSaleOrder::Add($arFields);	$ORDER_ID = IntVal($ORDER_ID);		$events = GetModuleEvents("linemedia.auto", "OnAfterOrderAdd");	while ($arEvent = $events->Fetch()) {		ExecuteModuleEventEx($arEvent, array($ORDER_ID, &$arFields));	}		$arFields['MANAGER_ID'] = $USER->GetId();		$events = GetModuleEvents("linemedia.auto", "OnOrderComplete");	while ($arEvent = $events->Fetch()) {		ExecuteModuleEventEx($arEvent, array($ORDER_ID, &$arFields));	}		if ($ORDER_ID > 0) {		// Привязка корзин к заказу.		CSaleBasket::OrderBasket($ORDER_ID, CSaleBasket::GetBasketUserID(), SITE_ID);			// Редирект на готовый заказ.		LocalRedirect($APPLICATION->GetCurPage().'?ORDER_ID='.$ORDER_ID);		exit();	}}